<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBA Placement OS | R. Ragul Renganath</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#2563eb',
                        brandLight: '#eff6ff',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        dark: '#1e293b'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar-link { transition: all 0.2s; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #2563eb; color: white; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col hidden md:flex">
        <div class="p-6 flex items-center gap-3">
            <div class="w-10 h-10 bg-brand rounded-lg flex items-center justify-center text-white font-bold text-xl">R</div>
            <div>
                <h1 class="font-bold text-gray-800">Placement OS</h1>
                <p class="text-xs text-gray-500">MBA Finance '27</p>
            </div>
        </div>
        
        <nav class="flex-1 px-4 space-y-2 mt-4">
            <a href="#" onclick="showSection('dashboard')" id="nav-dashboard" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600">
                <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
            </a>
            <a href="#" onclick="showSection('applications')" id="nav-applications" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600">
                <i class="fa-solid fa-briefcase w-5"></i> Applications
            </a>
            <a href="#" onclick="showSection('networking')" id="nav-networking" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600">
                <i class="fa-solid fa-users w-5"></i> Network CRM
            </a>
            <a href="#" onclick="showSection('weekly')" id="nav-weekly" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600">
                <i class="fa-solid fa-calendar-check w-5"></i> Weekly Review
            </a>
        </nav>

        <div class="p-4 border-t border-gray-200">
            <button onclick="exportData()" class="w-full flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg text-sm font-medium transition">
                <i class="fa-solid fa-download"></i> Export CSV
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative">
        <div class="md:hidden bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
            <span class="font-bold text-lg">Placement OS</span>
            <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('z-50'); document.querySelector('aside').classList.toggle('h-full');" class="text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </div>

        <div class="p-8 max-w-7xl mx-auto">
            
            <div id="dashboard" class="section-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Overview</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card p-5 border-l-4 border-brand">
                        <p class="text-sm text-gray-500 font-medium">Total Applied</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="kpi-total">-</h3>
                    </div>
                    <div class="card p-5 border-l-4 border-warning">
                        <p class="text-sm text-gray-500 font-medium">Interviews</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="kpi-interviews">-</h3>
                    </div>
                    <div class="card p-5 border-l-4 border-success">
                        <p class="text-sm text-gray-500 font-medium">Offers</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="kpi-offers">-</h3>
                    </div>
                    <div class="card p-5 border-l-4 border-danger">
                        <p class="text-sm text-gray-500 font-medium">Follow-ups Due</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="kpi-followups">-</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card p-6">
                        <h3 class="font-bold text-gray-700 mb-4">Conversion Funnel</h3>
                        <div class="h-64 relative">
                            <canvas id="funnelChart"></canvas>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="font-bold text-gray-700 mb-4">Immediate Actions</h3>
                        <div id="action-list" class="space-y-3 overflow-y-auto h-64">
                            <p class="text-sm text-gray-400 italic">Loading tasks...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="applications" class="section-content hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Application Tracker</h2>
                    <button onclick="toggleModal('appModal')" class="bg-brand hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium shadow-md flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Add New
                    </button>
                </div>

                <div class="card overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex gap-4">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="appSearch" onkeyup="renderApps()" placeholder="Search company, role..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand">
                        </div>
                        <select id="statusFilter" onchange="renderApps()" class="border border-gray-300 rounded-lg px-4 py-2 text-gray-600 focus:outline-none">
                            <option value="All">All Status</option>
                            <option value="Applied">Applied</option>
                            <option value="Interview">Interview</option>
                            <option value="Offer">Offer</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-xs uppercase text-gray-500 font-semibold">
                                    <th class="p-4">Company</th>
                                    <th class="p-4">Role</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4">Applied</th>
                                    <th class="p-4">Next Action</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="appTableBody" class="text-sm text-gray-700 divide-y divide-gray-100">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="networking" class="section-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Networking CRM</h2>
                    <button onclick="toggleModal('networkModal')" class="bg-brand hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium shadow-md">
                        <i class="fa-solid fa-user-plus"></i> Add Contact
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="networkGrid">
                    </div>
            </div>

            <div id="weekly" class="section-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Weekly Auto-Summary</h2>
                <div class="card p-8 bg-gradient-to-br from-white to-blue-50">
                    <h3 class="text-lg font-bold text-brand mb-2">Progress This Week</h3>
                    <p class="text-gray-600 mb-6">Here is a snapshot of your activity for your self-reflection.</p>
                    <div id="weekly-stats" class="space-y-4">
                        </div>
                </div>
            </div>

        </div>
    </main>

    <div id="appModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800">Track New Application</h3>
                <button onclick="toggleModal('appModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <form id="appForm" onsubmit="submitApp(event)" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Company</label>
                        <input type="text" name="company" required class="w-full border rounded p-2 focus:ring-2 ring-brand outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Role</label>
                        <input type="text" name="role" required class="w-full border rounded p-2 focus:ring-2 ring-brand outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Status</label>
                        <select name="status" class="w-full border rounded p-2 bg-white">
                            <option value="Applied">Applied</option>
                            <option value="Networking">Networking</option>
                            <option value="Interview">Interview</option>
                            <option value="Offer">Offer</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Applied Date</label>
                        <input type="date" name="applied_date" id="date_today_app" class="w-full border rounded p-2">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Next Follow Up</label>
                    <input type="date" name="next_follow_up" class="w-full border rounded p-2">
                </div>
                <button type="submit" class="w-full bg-brand text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition">Save Application</button>
            </form>
        </div>
    </div>

    <div id="networkModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800">Add Contact</h3>
                <button onclick="toggleModal('networkModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <form id="networkForm" onsubmit="submitNetwork(event)" class="p-6 space-y-4">
                <input type="text" name="name" placeholder="Name" required class="w-full border rounded p-2">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" name="company" placeholder="Company" class="w-full border rounded p-2">
                    <input type="text" name="role" placeholder="Role" class="w-full border rounded p-2">
                </div>
                <select name="relationship" class="w-full border rounded p-2 bg-white">
                    <option value="Cold">Cold</option>
                    <option value="Acquaintance">Acquaintance</option>
                    <option value="Warm">Warm</option>
                    <option value="Mentor">Mentor</option>
                </select>
                <textarea name="notes" placeholder="Notes / Context" class="w-full border rounded p-2 h-20"></textarea>
                <button type="submit" class="w-full bg-brand text-white py-2 rounded-lg font-bold">Save Contact</button>
            </form>
        </div>
    </div>

    <script>
        // --- A. INITIALIZATION ---
        const SUPABASE_URL = 'https://aeddptixtvbjoiljhzrr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlZGRwdGl4dHZiam9pbGpoenJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDgwNjIsImV4cCI6MjA4MzI4NDA2Mn0.53xYiJ-cRhUfVjsLsl0bQOphiT56ikpmXsM9Q4HwFw0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let applications = [];
        let contacts = [];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('date_today_app').valueAsDate = new Date();
            loadData();
        });

        // --- B. NAVIGATION ---
        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active', 'bg-brand', 'text-white'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.add('text-gray-600'));
            
            const activeLink = document.getElementById('nav-' + id);
            activeLink.classList.add('active');
            activeLink.classList.remove('text-gray-600');
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        // --- C. DATA FETCHING ---
        async function loadData() {
            // Fetch Applications
            const { data: appsData, error: appsError } = await supabase.from('applications').select('*').order('created_at', { ascending: false });
            if (appsData) applications = appsData;

            // Fetch Networking
            const { data: netData, error: netError } = await supabase.from('networking').select('*').order('created_at', { ascending: false });
            if (netData) contacts = netData;

            updateDashboard();
            renderApps();
            renderNetwork();
            renderWeekly();
        }

        // --- D. RENDERING & LOGIC ---

        function updateDashboard() {
            // KPIs
            document.getElementById('kpi-total').textContent = applications.length;
            document.getElementById('kpi-interviews').textContent = applications.filter(a => a.status === 'Interview' || a.status === 'Offer').length;
            document.getElementById('kpi-offers').textContent = applications.filter(a => a.status === 'Offer').length;
            
            // Follow ups logic
            const today = new Date().toISOString().split('T')[0];
            const due = applications.filter(a => a.next_follow_up && a.next_follow_up <= today && a.status !== 'Rejected' && a.status !== 'Offer');
            document.getElementById('kpi-followups').textContent = due.length;

            // Action List
            const listEl = document.getElementById('action-list');
            listEl.innerHTML = '';
            if (due.length === 0) listEl.innerHTML = '<p class="text-gray-500 text-sm">No pending follow-ups. Good job!</p>';
            due.slice(0, 5).forEach(app => {
                listEl.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded border border-red-100">
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${app.company}</p>
                            <p class="text-xs text-gray-500">Follow up due: ${app.next_follow_up}</p>
                        </div>
                        <span class="text-xs font-bold text-red-500">DUE</span>
                    </div>
                `;
            });

            // Funnel Chart
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('funnelChart').getContext('2d');
            const counts = {
                applied: applications.length,
                interview: applications.filter(a => ['Interview', 'Offer'].includes(a.status)).length,
                offer: applications.filter(a => a.status === 'Offer').length
            };

            // Destroy existing if needed (simple hack for this single file)
            if(window.myFunnel) window.myFunnel.destroy();

            window.myFunnel = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Applied', 'Interviews', 'Offers'],
                    datasets: [{
                        label: 'Pipeline',
                        data: [counts.applied, counts.interview, counts.offer],
                        backgroundColor: ['#93c5fd', '#2563eb', '#10b981'],
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderApps() {
            const tbody = document.getElementById('appTableBody');
            const search = document.getElementById('appSearch').value.toLowerCase();
            const filter = document.getElementById('statusFilter').value;

            tbody.innerHTML = '';

            const filtered = applications.filter(app => {
                const matchesSearch = app.company.toLowerCase().includes(search) || app.role.toLowerCase().includes(search);
                const matchesFilter = filter === 'All' || app.status === filter;
                return matchesSearch && matchesFilter;
            });

            filtered.forEach(app => {
                let badgeColor = 'bg-gray-100 text-gray-600';
                if(app.status === 'Interview') badgeColor = 'bg-blue-100 text-blue-700';
                if(app.status === 'Offer') badgeColor = 'bg-green-100 text-green-700';
                if(app.status === 'Rejected') badgeColor = 'bg-red-100 text-red-700';

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="p-4 font-bold text-gray-800">${app.company}</td>
                        <td class="p-4 text-gray-600">${app.role}</td>
                        <td class="p-4"><span class="status-badge ${badgeColor}">${app.status}</span></td>
                        <td class="p-4 text-gray-500">${app.applied_date || '-'}</td>
                        <td class="p-4 text-gray-500 text-xs">${app.next_follow_up || '-'}</td>
                        <td class="p-4 text-right">
                            <button class="text-gray-400 hover:text-brand"><i class="fa-solid fa-pen"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderNetwork() {
            const grid = document.getElementById('networkGrid');
            grid.innerHTML = '';
            
            contacts.forEach(c => {
                let border = 'border-l-4 border-gray-300';
                if(c.relationship === 'Warm') border = 'border-l-4 border-yellow-400';
                if(c.relationship === 'Mentor') border = 'border-l-4 border-purple-500';

                grid.innerHTML += `
                    <div class="card p-5 ${border}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg text-gray-800">${c.name}</h4>
                                <p class="text-sm text-gray-600">${c.role} @ ${c.company || 'Unknown'}</p>
                            </div>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded">${c.relationship}</span>
                        </div>
                        <p class="mt-3 text-xs text-gray-400">Last Contact: ${c.last_contact || 'Never'}</p>
                        <p class="mt-2 text-sm text-gray-600 italic line-clamp-2">"${c.notes || 'No notes'}"</p>
                    </div>
                `;
            });
        }

        function renderWeekly() {
            // Simple logic: Applications in last 7 days
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const recent = applications.filter(a => new Date(a.applied_date) >= weekAgo);
            const container = document.getElementById('weekly-stats');
            
            if (recent.length === 0) {
                container.innerHTML = `<p>No applications sent in the last 7 days.</p>`;
            } else {
                container.innerHTML = `
                    <div class="flex items-center gap-4 mb-4">
                        <div class="text-4xl font-bold text-brand">${recent.length}</div>
                        <div class="text-gray-600">Applications sent<br>this week</div>
                    </div>
                    <ul class="list-disc pl-5 text-gray-600 space-y-1">
                        ${recent.map(a => `<li>Applied to <b>${a.company}</b> as ${a.role}</li>`).join('')}
                    </ul>
                `;
            }
        }

        // --- E. SUBMISSION HANDLERS ---
        async function submitApp(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newApp = {
                company: formData.get('company'),
                role: formData.get('role'),
                status: formData.get('status'),
                applied_date: formData.get('applied_date') || null,
                next_follow_up: formData.get('next_follow_up') || null
            };

            const { error } = await supabase.from('applications').insert(newApp);
            if (!error) {
                toggleModal('appModal');
                e.target.reset();
                loadData(); // Refresh UI
            } else {
                alert("Error saving: " + error.message);
            }
        }

        async function submitNetwork(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newContact = {
                name: formData.get('name'),
                company: formData.get('company'),
                role: formData.get('role'),
                relationship: formData.get('relationship'),
                notes: formData.get('notes')
            };
            
            const { error } = await supabase.from('networking').insert(newContact);
            if (!error) {
                toggleModal('networkModal');
                e.target.reset();
                loadData();
            } else {
                alert("Error saving: " + error.message);
            }
        }

        // --- F. EXPORT CSV ---
        function exportData() {
            if (applications.length === 0) return alert("No data to export");
            
            const headers = Object.keys(applications[0]).join(",");
            const rows = applications.map(obj => Object.values(obj).map(val => `"${val}"`).join(",")).join("\n");
            const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + rows;
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "placement_tracker_export.csv");
            document.body.appendChild(link);
            link.click();
        }

    </script>
</body>
</html>


